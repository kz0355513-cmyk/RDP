name: SSH - Powerful Max Runner (Linux)

on:
  workflow_dispatch:

jobs:
  secure-ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Configure SSH and Generate Credentials ðŸ”‘
        run: |
          export RDP_USER="gh-user"
          password=$(LC_ALL=C tr -dc 'A-Za-z0-9!@#$%^&*()_+{}[]|:<>?~' < /dev/urandom | head -c 16)
          
          sudo useradd -m -s /bin/bash $RDP_USER
          echo "$RDP_USER:$password" | sudo chpasswd
          sudo usermod -aG sudo $RDP_USER
          
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          
          echo "RDP_USER=$RDP_USER" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $GITHUB_ENV
          
          echo "SSH User setup complete."

      - name: Install Tailscale ðŸŒ (Fixed URL)
        run: |
          # Use the official, reliable repository method
          sudo apt-get update
          sudo apt-get install -y curl
          
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.asc | sudo gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          sudo apt-get update
          sudo apt-get install -y tailscale
          
          # Start the Tailscale service daemon in the background
          sudo /usr/sbin/tailscaled --tun=userspace-networking &

      - name: Establish Tailscale Connection (Authenticate)
        run: |
          # Use the 'tailscale up' command to authenticate
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-linux-runner-$GITHUB_RUN_ID

          ts_ip=$(sudo tailscale ip -4)
          if [ -z "$ts_ip" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$ts_ip" >> $GITHUB_ENV
          echo "Tailscale connected with IP: $ts_ip"

      - name: Maintain Connection and Display Access Info âœ¨ (Final Step)
        run: |
          echo -e "\n=== SSH ACCESS INFO ==="
          echo "Runner is ACTIVE. You have up to 6 hours of access."
          echo "Address: $TAILSCALE_IP"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASSWORD"
          echo "Connect with: ssh $RDP_USER@$TAILSCALE_IP"
          echo "======================\n"
          
          while true; do
            echo "[$(date)] Runner Active - Use 'Cancel workflow' to terminate"
            sleep 300
          done
