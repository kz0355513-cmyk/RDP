name: RDP - Linux Desktop Runner (VNC + Tailscale)

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Desktop and VNC Server üñ•Ô∏è
        run: |
          # 1. Update system and install necessary packages
          sudo apt-get update
          sudo apt-get install -y xfce4 xfce4-goodies tightvncserver curl

          # 2. Set VNC password for security (it will be obfuscated in logs)
          VNC_PASSWORD=$(LC_ALL=C tr -dc 'A-Za-z0-9' < /dev/urandom | head -c 12)
          mkdir -p ~/.vnc
          echo "$VNC_PASSWORD" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # 3. Create the startup script for VNC (xstartup)
          echo '#!/bin/bash' > ~/.vnc/xstartup
          echo 'xrdb $HOME/.Xresources' >> ~/.vnc/xstartup
          echo 'startxfce4 &' >> ~/.vnc/xstartup
          chmod +x ~/.vnc/xstartup

          # 4. Start the VNC server on display 1 (port 5901)
          # Use -geometry 1280x720 for a common size
          tightvncserver :1 -geometry 1280x720 -depth 24
          
          echo "VNC_PASSWORD=$VNC_PASSWORD" >> $GITHUB_ENV
          echo "VNC_PORT=5901" >> $GITHUB_ENV
          echo "VNC setup complete. VNC Server is running on port 5901."

      - name: Establish Tailscale Connection üåê
        # Use the reliable official action for Linux
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }} 
          hostname: gh-linux-desktop-${{ github.run_id }}
          args: "--tun=userspace-networking"
          
      - name: Get Tailscale IP Address
        run: |
          ts_ip=$(/usr/bin/tailscale ip -4)
          if [ -z "$ts_ip" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi
          echo "TAILSCALE_IP=$ts_ip" >> $GITHUB_ENV

      - name: Maintain Connection and Display Access Info ‚ú® (Final Step)
        run: |
          echo -e "\n=== REMOTE DESKTOP ACCESS INFO ==="
          echo "Runner is ACTIVE. You have up to 6 hours of access."
          echo "**Network (via Tailscale):** $TAILSCALE_IP"
          echo "**VNC Port:** $VNC_PORT"
          echo "**VNC Password:** $VNC_PASSWORD"
          echo -e "\n**Connection Address (for VNC Client):** $TAILSCALE_IP:$VNC_PORT"
          echo "===================================\n"
          
          # Keep the workflow job running until the timeout is reached
          while true; do
            echo "[$(date)] Runner Active - Use 'Cancel workflow' to terminate"
            sleep 300
          done
