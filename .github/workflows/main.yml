name: SSH - Powerful Max Runner (Linux)

on:
  # This allows you to manually run the workflow for SSH access
  workflow_dispatch:

jobs:
  secure-ssh:
    # Use the most powerful Linux runner available
    runs-on: ubuntu-latest
    # Set the session duration to the maximum limit (6 hours)
    timeout-minutes: 360

    steps:
      - name: Configure SSH and Generate Credentials ðŸ”‘
        run: |
          # 1. Generate a random, secure password for the SSH user
          export RDP_USER="gh-user"
          password=$(LC_ALL=C tr -dc 'A-Za-z0-9!@#$%^&*()_+{}[]|:<>?~' < /dev/urandom | head -c 16)
          
          # 2. Create the new user and set their password
          sudo useradd -m -s /bin/bash $RDP_USER
          echo "$RDP_USER:$password" | sudo chpasswd
          
          # 3. Add the user to the 'sudo' group for administrative access
          sudo usermod -aG sudo $RDP_USER
          
          # 4. Enable SSH service and allow password authentication
          sudo apt-get update
          sudo apt-get install -y openssh-server
          sudo systemctl enable ssh
          sudo systemctl start ssh
          
          # Ensure PasswordAuthentication is set to yes in sshd_config
          sudo sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          
          # 5. Export credentials as environment variables for subsequent steps
          echo "RDP_USER=$RDP_USER" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$password" >> $GITHUB_ENV
          
          echo "SSH User setup complete."

      - name: Install Tailscale ðŸŒ
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tgz | tar zx
          sudo cp -f jammy/tailscale /usr/bin/tailscale
          sudo cp -f jammy/tailscaled /usr/sbin/tailscaled
          
          # Start the Tailscale service
          sudo tailscaled &

      - name: Establish Tailscale Connection (Authenticate)
        run: |
          # The Tailscale 'up' command connects to your tailnet using an auth key
          # ${{ secrets.TAILSCALE_AUTH_KEY }} must be set as a repository secret
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-linux-runner-$GITHUB_RUN_ID

          ts_ip=$(sudo tailscale ip -4)
          if [ -z "$ts_ip" ]; then
            echo "Tailscale IP not assigned. Exiting."
            exit 1
          fi
          
          echo "TAILSCALE_IP=$ts_ip" >> $GITHUB_ENV
          echo "Tailscale connected with IP: $ts_ip"

      - name: Maintain Connection and Display Access Info âœ¨ (Final Step)
        run: |
          echo -e "\n=== SSH ACCESS INFO ==="
          echo "Runner is ACTIVE. You have up to 6 hours of access."
          echo "Address: $TAILSCALE_IP (use this IP or its MagicDNS hostname)"
          echo "Username: $RDP_USER"
          echo "Password: $RDP_PASSWORD"
          echo "Connect with: ssh $RDP_USER@$TAILSCALE_IP"
          echo "======================\n"
          
          # Keep the workflow job running until the timeout is reached (6 hours)
          while true; do
            echo "[$(date)] Runner Active - Use 'Cancel workflow' to terminate"
            sleep 300 # Sleep for 5 minutes
          done
